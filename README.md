# Telegraph-Image
免費圖片托管解決方案，Flickr/imgur替代品。使用Cloudflare Pages和Telegraph。

[English](README.md)|中文

## 如何部署

### 提前準備
你唯一需要提前準備的就是一個Cloudflare賬戶

### 手把手教程
簡單3步，即可部署本項目，擁有自己的圖床

1.下載或Fork本倉庫 (註意：目前請使用fork，在使用下載[#14](https://github.com/cf-pages/Telegraph-Image/issues/14)部署存在問題)

2.打開Cloudflare Dashboard，進入Pages管理頁面，選擇創建項目，如果在第一步中選擇的是fork本倉庫，則選擇`連接到 Git 提供程序`，如果第一步中選擇的是下載本倉庫則選擇`直接上傳`
![1](https://telegraph-image.pages.dev/file/8d4ef9b7761a25821d9c2.png)

3. 按照頁面提示輸入項目名稱，選擇需要連接的git倉庫（第一步選擇的是fork）或是上傳剛剛下載的倉庫文件（第一步選擇的是下載本倉庫），點擊`部署站點`即可完成部署

## 特性
1.無限圖片儲存數量，你可以上傳不限數量的圖片

2.無需購買服務器，托管於Cloudflare的網絡上，當使用量不超過Cloudflare的免費額度時，完全免費

3.無需購買域名，可以使用Cloudflare Pages提供的`*.pages.dev`的免費二級域名，同時也支持綁定自定義域名

4.支持圖片審查API，可根據需要開啟，開啟後不良圖片將自動屏蔽，不再加載

5.支持後臺圖片管理，可以對上傳的圖片進行在線預覽，添加白名單，黑名單等操作

### 綁定自定義域名
在pages的自定義域里面，綁定cloudflare中存在的域名，在cloudflare托管的域名，自動會修改dns記錄
![2](https://telegraph-image.pages.dev/file/29546e3a7465a01281ee2.png)

### 開啟圖片審查
1.請前往https://moderatecontent.com/ 註冊並獲得一個免費的用於審查圖像內容的API key

2.打開Cloudflare Pages的管理頁面，依次點擊`設置`，`環境變量`，`添加環境變量`

3.添加一個`變量名稱`為`ModerateContentApiKey`，`值`為你剛剛第一步獲得的`API key`，點擊`保存`即可

註意：由於所做的更改將在下次部署時生效，你或許還需要進入`部署`頁面，重新部署一下該本項目

開啟圖片審查後，因為審查需要時間，首次的圖片加載將會變得緩慢，之後的圖片加載由於存在緩存，並不會受到影響
![3](https://tpic.pages.dev/file/bae511fb116b034ef9c14.png)

### 限制
1.由於圖片文件實際存儲於Telegraph，Telegraph限制上傳的圖片大小最大為5MB

2.由於使用Cloudflare的網絡，圖片的加載速度在某些地區可能得不到保證

3.Cloudflare Function免費版每日限制100,000個請求（即上傳或是加載圖片的總次數不能超過100,000次）如超過可能需要選擇購買Cloudflare Function的付費套餐，如開啟圖片管理功能還會存在KV操作數量的限制，如超過需購買付費套餐

### 感謝
Hostloc @feixiang和@烏拉擦 提供的思路和代碼

## 更新日誌
2023年1月18日--圖片管理功能更新

1、支持圖片管理功能，默認是關閉的，如需開啟請部署完成後前往後臺依次點擊`設置`->`函數`->`KV 命名空間綁定`->`編輯綁定`->`變量名稱`填寫：`img_url` `KV 命名空間` 選擇你提前創建好的KV儲存空間，開啟後訪問http(s)://你的域名/admin 即可打開後臺管理頁面
| 變量名稱      | KV 命名空間 |
| ----------- | ----------- |
| img_url     | 選擇提前創建好的KV儲存空間 |

![](https://im.gurl.eu.org/file/a0c212d5dfb61f3652d07.png)
![](https://im.gurl.eu.org/file/48b9316ed018b2cb67cf4.png)

2、後臺管理頁面新增登錄驗證功能，默認也是關閉的，如需開啟請部署完成後前往後臺依次點擊`設置`->`環境變量`->`為生產環境定義變量`->`編輯變量` 添加如下表格所示的變量即可開啟登錄驗證
| 變量名稱      | 值 |
| ----------- | ----------- |
|BASIC_USER   = | <後臺管理頁面登錄用戶名稱>|
|BASIC_PASS    = | <後臺管理頁面登錄用戶密碼>|

![](https://im.gurl.eu.org/file/dff376498ac87cdb78071.png)

當然你也可以不設置這兩個值，這樣訪問後臺管理頁面時將無需驗證，直接跳過登錄步驟，這一設計使得你可以結合Cloudflare Access進行使用，實現支持郵件驗證碼登錄，Microsoft賬戶登錄，Github賬戶登錄等功能，能夠與你域名上原有的登錄方式所集成，無需再次記憶多一組後臺的賬號密碼，添加Cloudflare Access的方式請參考官方文檔，註意需要保護路徑包括/admin 以及 /api/manage/*

3、新增圖片總數量統計
當開啟圖片管理功能後，可在後臺頂部查看記錄中的圖片數量

![](https://im.gurl.eu.org/file/b7a37c08dc2c504199824.png)

4、新增圖片文件名搜索
當開啟圖片管理功能後，可在後臺搜索框使用圖片文件名稱，快速搜索定位需要管理的圖片

![](https://im.gurl.eu.org/file/faf6d59a7d4a48a555491.png)

5、新增圖片狀態顯示
當開啟圖片管理功能後，可在後臺查看圖片當前的狀態{ "ListType": "None", "TimeStamp": 1673984678274 }
ListType代表圖片當前是否在黑白名單當中，None則表示既不在黑名單中也不在白名單中，White表示在在白名單中，Block表示在黑名單中，TimeStamp為圖片首次加載的時間戳，如開啟的圖片審查API，則這里還會顯示圖片審查的結果用Label標識

![](https://im.gurl.eu.org/file/6aab78b83bbd8c249ee29.png)

6、新增黑名單功能
當開啟圖片管理功能後，可在後臺手動為圖片加入黑名單，加入黑名單的圖片將無法正常加載

![](https://im.gurl.eu.org/file/fb18ef006a23677a52dfe.png)

7、新增白名單功能
當開啟圖片管理功能後，可在後臺手動為圖片加入白名單，加入白名單的圖片無論如何都會正常加載，可繞過圖片審查API的結果

![](https://im.gurl.eu.org/file/2193409107d4f2bcd00ee.png)

8、新增記錄刪除功能
當開啟圖片管理功能後，可在後臺手動刪除圖片記錄，即不再後臺顯示該圖片，除非有人再次上傳並加載該圖片，註意由於圖片儲存在telegraph的服務器上，我們無法刪除上傳的原始圖片，只能通過上述第6點的黑名單功能屏蔽圖片的加載

9、新增程序運行模式：白名單模式
當開啟圖片管理功能後，除了默認模式外，這次更新還新增了一項新的運行模式，在該模式下，只有被添加進白名單的圖片才會被加載，上傳的圖片需要審核通過後才能展示，最大程度的防止不良圖片的加載，如需開啟請設置環境變量：WhiteList_Mode=="true"

10、新增後臺圖片預覽功能
當開啟圖片管理功能後，可在後臺預覽通過你的域名加載過的圖片，點擊圖片可以進行放大，縮小，旋轉等操作

![](https://im.gurl.eu.org/file/740cd5a69672de36133a2.png)

## 已經部署了的，如何更新？
其實更新非常簡單，只需要參照上面的更新內容，先進入到Cloudflare Pages後臺，把需要使用的環境變量提前設置好並綁定上KV命名空間，然後去到Github你之前fork過的倉庫依次選擇`Sync fork`->`Update branch`即可，稍等一會，Cloudflare Pages那邊檢測到你的倉庫更新了之後就會自動部署最新的代碼了

## 一些限制：
Cloudflare KV每天只有1000次的免費寫入額度，每有一張新的圖片加載都會占用該寫入額度，如果超過該額度，圖片管理後臺將無法記錄新加載的圖片

每天最多 100,000 次免費讀取操作，圖片每加載一次都會占用該額度（在沒有緩存的情況下，如果你的域名在Cloudflare開啟了緩存，當緩存未命中時才會占用該額度），超過黑白名單等功能可能會失效

每天最多 1,000 次免費刪除操作，每有一條圖片記錄都會占用該額度，超過將無法刪除圖片記錄

每天最多 1,000 次免費列出操作，每打開或刷新一次後臺/admin都會占用該額度，超過將進行後臺圖片管理

絕大多數情況下，該免費額度都基本夠用，並且可以稍微超出一點，不是已超出就立馬停用，且每項額度單獨計算，某項操作超出免費額度後只會停用該項操作，不影響其他的功能，即即便我的免費寫入額度用完了，我的讀寫功能不受影響，圖片能夠正常加載，只是不能在圖片管理後臺看到新的圖片了。

如果你的免費額度不夠用，可以自行向Cloudflare購買Cloudflare Workers的付費版本，每月$5起步，按量收費，沒有上述額度限制

另外針對環境變量所做的更改將在下次部署時生效，如更改了`環境變量`，針對某項功能進行了開啟或關閉，請記得重新部署。

![](https://im.gurl.eu.org/file/b514467a4b3be0567a76f.png)

### Sponsorship 
This project is tested with BrowserStack.
